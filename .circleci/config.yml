# yaml-language-server: $schema = https://json.schemastore.org/circleciconfig.json
version: 2.1

jobs:
  build_and_publish:
    parameters:
      image:
        description: Machine image name
        type: string
      resource_class:
        description: Resource class of machine
        type: string
      platform:
        description: Platform for image
        type: string
    machine:
      image: << parameters.image >>
    resource_class: << parameters.resource_class >>
    steps:
      - checkout
      - run: 
          name: Docker Login
          command: |
            docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_TOKEN
      - run:
          name: Setup Multi-Arch Support
          command: |
            docker buildx ls
            docker context create buildx_context
            docker buildx create buildx_context --use
            docker buildx inspect --bootstrap
      - run:
          name: Docker Build
          command: |
            docker build \
              --platform << parameters.platform >> \
              --tag brutalsimplicity/devcontainer:latest .
      - when:
          condition:
            matches:
              pattern: "^v.+$"
              value: << pipeline.git.tag >>
          steps:
            - run:
                name: Docker Publish
                command: |
                  platform="<< parameters.platform >>"
                  validPlatform=${platform/linux\//}
                  docker tag brutalsimplicity/devcontainer:latest brutalsimplicity/devcontainer:<< pipeline.git.tag >>-${validPlatform}
                  docker push brutalsimplicity/devcontainer:<< pipeline.git.tag >>-${validPlatform}
                  docker push brutalsimplicity/devcontainer:<< pipeline.git.tag >>-latest
  # create_manifest:
  #   machine:
  #     image: ubuntu-2004:202101-01
  #   resource_class: << parameters.resource_class >>
  #   steps:
  #     - checkout
  #     - run:
  #         name: Docker Install Test
  #         command: |
  #           docker --help || true
  #     - run: 
  #         name: Docker Login
  #         command: |
  #           docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_TOKEN
  #     - run:
  #         name: Docker Create Manifest
  #         command: |
  #           docker manifest create

workflows:
  build_and_publish_arm64:
    jobs:
      - build_and_publish:
          name: Build and Publish ARM64
          image: ubuntu-2004:202101-01
          resource_class: arm.medium
          platform: linux/arm64
          context: cloud-magix
          filters:
            branches:
              only: main
            tags:
              only: /v.*/

      - build_and_publish:
          name: Build and Publish AMD64
          image: ubuntu-2004:202101-01
          resource_class: medium
          platform: linux/amd64
          context: cloud-magix
          filters:
            branches:
              only: main
            tags:
              only: /v.*/
            
        